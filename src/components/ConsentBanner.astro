---
// ConsentBanner ‚Äì Cookie consent with category toggles
// Blocks analytics/marketing/embeds until user consents
---

<div id="consent-banner" class="fixed bottom-0 inset-x-0 z-[9999] p-4 transition-transform duration-500 translate-y-full" role="dialog" aria-label="Cookie-Einstellungen">
  <div class="container-wide">
    <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-6 sm:p-8 max-w-4xl mx-auto">
      <div class="flex flex-col lg:flex-row gap-6 items-start">
        <div class="flex-1">
          <h3 class="font-heading font-bold text-lg text-dark-900 mb-2">üç™ Cookie-Einstellungen</h3>
          <p class="text-sm text-gray-600 leading-relaxed mb-4">
            Wir verwenden Cookies, um Ihnen die beste Erfahrung auf unserer Website zu bieten.
            Einige sind notwendig, andere helfen uns, die Website zu verbessern.
            <a href="/cookie-richtlinie" class="text-brand-600 hover:text-brand-500 underline">Mehr erfahren</a>
          </p>

          <!-- Category Toggles (shown in settings view) -->
          <div id="consent-settings" class="hidden space-y-3 mb-4">
            <label class="flex items-center gap-3 cursor-not-allowed">
              <input type="checkbox" checked disabled class="w-4 h-4 rounded text-brand-600" />
              <span class="text-sm font-medium text-gray-700">Notwendig</span>
              <span class="text-xs text-gray-400">(immer aktiv)</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="consent-analytics" class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" />
              <span class="text-sm font-medium text-gray-700">Analyse &amp; Statistik</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="consent-marketing" class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" />
              <span class="text-sm font-medium text-gray-700">Marketing</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="consent-embeds" class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" />
              <span class="text-sm font-medium text-gray-700">Externe Inhalte (Videos, Karten, Kalender)</span>
            </label>
          </div>
        </div>

        <div class="flex flex-col gap-2 shrink-0 w-full lg:w-auto">
          <button id="consent-accept-all"
            class="px-6 py-3 text-sm font-semibold text-white gradient-brand rounded-xl shadow-md hover:shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all duration-200">
            Alle akzeptieren
          </button>
          <button id="consent-save"
            class="hidden px-6 py-3 text-sm font-semibold text-brand-700 bg-brand-50 border border-brand-200 rounded-xl hover:bg-brand-100 transition-all duration-200">
            Auswahl speichern
          </button>
          <button id="consent-necessary-only"
            class="px-6 py-3 text-sm font-semibold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-all duration-200">
            Nur notwendige
          </button>
          <button id="consent-toggle-settings"
            class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">
            Einstellungen
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  type ConsentState = { analytics: boolean; marketing: boolean; embeds: boolean };

  const STORAGE_KEY = 'energierichter_consent';
  const banner = document.getElementById('consent-banner')!;
  const settingsPanel = document.getElementById('consent-settings')!;
  const saveBtn = document.getElementById('consent-save')!;
  const cbAnalytics = document.getElementById('consent-analytics') as HTMLInputElement;
  const cbMarketing = document.getElementById('consent-marketing') as HTMLInputElement;
  const cbEmbeds = document.getElementById('consent-embeds') as HTMLInputElement;

  // Expose global consent state
  (window as any).__consent = { analytics: false, marketing: false, embeds: false };

  function getStoredConsent(): ConsentState | null {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function saveConsent(state: ConsentState) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    (window as any).__consent = state;
    activateScripts(state);
    hideBanner();
  }

  function activateScripts(state: ConsentState) {
    // Unblock scripts marked with data-consent
    document.querySelectorAll<HTMLScriptElement>('script[data-consent]').forEach((el) => {
      const category = el.dataset.consent as keyof ConsentState;
      if (state[category]) {
        const clone = document.createElement('script');
        clone.textContent = el.textContent;
        Array.from(el.attributes).forEach((a) => {
          if (a.name !== 'type' && a.name !== 'data-consent') clone.setAttribute(a.name, a.value);
        });
        el.replaceWith(clone);
      }
    });

    // Unblock iframes
    document.querySelectorAll<HTMLElement>('[data-consent-src]').forEach((el) => {
      const category = el.dataset.consent as keyof ConsentState;
      if (state[category] && el instanceof HTMLIFrameElement) {
        el.src = el.dataset.consentSrc!;
        el.removeAttribute('data-consent-src');
      }
    });
  }

  function showBanner() {
    banner.classList.remove('translate-y-full');
    banner.classList.add('translate-y-0');
  }

  function hideBanner() {
    banner.classList.add('translate-y-full');
    banner.classList.remove('translate-y-0');
  }

  // Init
  const stored = getStoredConsent();
  if (stored) {
    (window as any).__consent = stored;
    activateScripts(stored);
  } else {
    setTimeout(showBanner, 800);
  }

  // Accept All
  document.getElementById('consent-accept-all')?.addEventListener('click', () => {
    saveConsent({ analytics: true, marketing: true, embeds: true });
  });

  // Necessary Only
  document.getElementById('consent-necessary-only')?.addEventListener('click', () => {
    saveConsent({ analytics: false, marketing: false, embeds: false });
  });

  // Toggle Settings
  document.getElementById('consent-toggle-settings')?.addEventListener('click', () => {
    const visible = !settingsPanel.classList.contains('hidden');
    settingsPanel.classList.toggle('hidden', visible);
    saveBtn.classList.toggle('hidden', visible);
  });

  // Save Selection
  saveBtn.addEventListener('click', () => {
    saveConsent({
      analytics: cbAnalytics.checked,
      marketing: cbMarketing.checked,
      embeds: cbEmbeds.checked,
    });
  });
</script>
