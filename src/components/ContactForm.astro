---
export interface Props {
  showUpload?: boolean;
}

const { showUpload = false } = Astro.props;

import FileUpload from './FileUpload.astro';
import DoubleOptIn from './DoubleOptIn.astro';
---

<div id="contact-form-wrapper">
  <form id="contact-form" class="space-y-6" novalidate>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <!-- Name -->
      <div>
        <label for="cf-name" class="block text-sm font-medium text-gray-700 mb-1.5">Name *</label>
        <input type="text" id="cf-name" name="name" required
          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 transition-all outline-none text-sm"
          placeholder="Max Mustermann" />
      </div>
      <!-- Email -->
      <div>
        <label for="cf-email" class="block text-sm font-medium text-gray-700 mb-1.5">E-Mail *</label>
        <input type="email" id="cf-email" name="email" required
          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 transition-all outline-none text-sm"
          placeholder="max@beispiel.de" />
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <!-- Phone -->
      <div>
        <label for="cf-phone" class="block text-sm font-medium text-gray-700 mb-1.5">Telefon</label>
        <input type="tel" id="cf-phone" name="phone"
          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 transition-all outline-none text-sm"
          placeholder="+49 123 456789" />
      </div>
      <!-- Customer Type -->
      <div>
        <label for="cf-type" class="block text-sm font-medium text-gray-700 mb-1.5">Kundentyp</label>
        <select id="cf-type" name="customerType"
          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 transition-all outline-none text-sm bg-white">
          <option value="">Bitte wählen</option>
          <option value="privat">Privatkunde</option>
          <option value="kmu">KMU / Gewerbe</option>
          <option value="industrie">Industrie</option>
          <option value="immobilien">Immobilienverwalter</option>
        </select>
      </div>
    </div>

    <!-- Message -->
    <div>
      <label for="cf-message" class="block text-sm font-medium text-gray-700 mb-1.5">Nachricht</label>
      <textarea id="cf-message" name="message" rows={4}
        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 transition-all outline-none text-sm resize-y"
        placeholder="Beschreiben Sie kurz Ihr Anliegen ..."></textarea>
    </div>

    <!-- File Upload (optional) -->
    {showUpload && (
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">Dokumente (optional)</label>
        <FileUpload />
      </div>
    )}

    <!-- Privacy Checkbox -->
    <label class="flex items-start gap-3 cursor-pointer">
      <input type="checkbox" id="cf-privacy" name="privacy" required
        class="mt-1 w-4 h-4 rounded text-brand-600 focus:ring-brand-500" />
      <span class="text-sm text-gray-600 leading-relaxed">
        Ich stimme der Verarbeitung meiner Daten gemäß der
        <a href="/datenschutz" class="text-brand-600 hover:text-brand-500 underline">Datenschutzerklärung</a> zu. *
      </span>
    </label>

    <!-- Submit -->
    <button type="submit" id="cf-submit"
      class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-8 py-4 text-base font-semibold text-white gradient-brand rounded-xl shadow-md hover:shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
      Anfrage absenden
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    </button>
  </form>

  <DoubleOptIn />
</div>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const doiSection = document.getElementById('double-opt-in')!;
  const doiEmail = document.getElementById('doi-email')!;

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // Basic validation
    const name = (document.getElementById('cf-name') as HTMLInputElement).value.trim();
    const email = (document.getElementById('cf-email') as HTMLInputElement).value.trim();
    const privacy = (document.getElementById('cf-privacy') as HTMLInputElement).checked;

    if (!name || !email || !privacy) {
      // Highlight invalid fields
      form.querySelectorAll(':invalid').forEach((el) => {
        (el as HTMLElement).classList.add('border-red-400', 'ring-red-400/20');
      });
      return;
    }

    // Show DOI confirmation (backend would send email here)
    doiEmail.textContent = email;
    form.classList.add('hidden');
    doiSection.classList.remove('hidden');

    // Scroll to confirmation
    doiSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
</script>
